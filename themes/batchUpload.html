<!doctype html>
<html>
<head>
<title>Ava is reading...</title>
{template c_link.html}
</head>

<body>
{template c_header.html}
<div class="main_form">
    <h1>批量上传</h1>
	<div class="related"><a href="{$WEB_ROOT}upload.php">单个文件上传</a></div>
	<form id="buForm">
        <input type="hidden" name="act" value="batchUpload">
		<input type="hidden" name="legalDir" value="">
		<table class="tbl" id="setDir">
			<tr>
				<th>目录：</th>
				<td><input type="text" class="text" name="dir" id="dir"></td>
				<td><input type="button" class="btn2 ml" value="验证目录" onclick="verifyDir()"></td>
			</tr>
		</table>
		<div class="batchOption" style="display:none">
            <table class="tbl">
                <tr>
                    <th width="80">分类：</th>
					<td width="280"><div class="sele">
                            <input type="hidden" name="btype" value="0">
                            <span>-</span>
							<ul>
								<!--{loop $attr_type $type}-->
                                <li>{$type}</li>
								<!--{/loop}-->
                            </ul>
                        </div></td>						
                    <td><span id="btypeTip"></span></td>
                </tr>
				<tr>
					<th>标签：</th>
					<td colspan="2">
						<ul class="optionList">
							<!--{loop $attr_tags $key $tag}-->
							<li><input type="checkbox" name='btags[]' value="{$key}"> <label>{$tag}</label></li>
							<!--{/loop}-->
						</ul>
						<p id="btagsTip"></p>
					</td>
				</tr>
				<tr>
					<td colspan="3"><input class="btn1" type="button" value="上  传" onclick="doBatchUpload()"></td>
				</tr>
            </table>
		</div>
    </form>	
</div>
{template c_footer.html}
<script>
function showLoading(str) {
	$('.main_form').append('<div class="fileList">' + loading + str + '</div>');	
}

function hideLoading() {
	$('img.loading').parent().remove();
}

function doBatchUpload(){
	var dir = $('#dir').val();
	if(!dir || (dir != $('input[name="legalDir"]').val())) {
		verifyDir();
		return false;
	}	
	
	var btype = $('input[name="btype"]');
	var btags = $('input[name="btags[]"]:checked');
	if(btype.val() == 0) {
		$('#btypeTip').html('请选择分类').addClass('error').show();
		btype.next().mousedown(function() {
			$('#btypeTip').html('').removeClass('error').hide();
		});
		return false;
	}
	if(btags.length > 5) {
		$('#btagsTip').html('标签不能超过5个').addClass('error').show();
		btags.click(function() {
			$('#btagsTip').html('').removeClass('error').hide();
		});
		return false;
	}
	
	var options = {
		type: 'POST',
		url: WEB_ROOT + 'batchUpload.php',
		dataType: 'json',
		beforeSubmit: function() {
			$('input[name="btype"]').parent().selectInit();	
			$('.batchOption').hide();
			$('.fileList').remove();
			showLoading('文件正在上传，请稍候...');
		},
		success: function(r) {
			hideLoading();
			if(r.code == 0) {
				var result = '';
				if(r.illegal.length > 0) {
					result += '<div class="fileList bbord">';
					result += '<h3>' + r.illegal.length + ' 个文件上传失败</h3>';
					result += '<table><thead><tr>';
					result += '<td>书名</td><td>作者</td><td>格式</td><td>文件路径</td>';
					result += '</tr></thead><tbody>';					
					for(var key in r.illegal) {
						var file = r.illegal[key];
						result += '<tr>';
						result += '<td>' + file.bname + '</td>';
						result += '<td>' + file.bauthor + '</td>';
						result += '<td>' + file.bformat + '</td>';
						result += '<td>' + file.bpath + '</td>';
						result += '</tr>';
					}
					result += '</tbody></table></div>';
				}
				if(r.legal.length > 0) {
					if(result != '') {
						result += '<div class="fileList bbord" style="border-top:none; margin-top:0">';
					} else {
						result += '<div class="fileList bbord">';
					}
					result += '<h3>' + r.legal.length + ' 个文件上传成功</h3>';
					result += '<table><thead><tr>';
					result += '<td>书名</td><td>作者</td><td>格式</td><td>文件路径</td>';
					result += '</tr></thead><tbody>';					
					for(var key in r.legal) {
						var file = r.legal[key];
						result += '<tr>';
						result += '<td>' + file.bname + '</td>';
						result += '<td>' + file.bauthor + '</td>';
						result += '<td>' + file.bformat + '</td>';
						result += '<td>' + file.bpath + '</td>';
						result += '</tr>';
					}
					result += '</tbody></table></div>';
				}
				$('.main_form').append(result);
			} else {
				alert('error');
			}
		}
	};
	$('#buForm').ajaxSubmit(options);
	return false;
}

function verifyDir() {
	$('input[name="btype"]').parent().selectInit();	
	$('.batchOption').hide();
	$('.fileList').remove();

	var dir = $('#dir').val();
	if(! dir) {
		$('#dir').focus();
		return false;
	} else {
		$.ajax({
			type: 'POST',
			url: WEB_ROOT + 'batchUpload.php',
			dataType: 'json',
			data: {
				'act':'verifyDir', 
				'dir': dir
			},
			beforeSend: function() {
				showLoading('正在验证目录，请稍候...');
			},
			success: function(r){
				hideLoading();
				if(r.code == 0) {
					$('input[name="legalDir"]').val(dir);
					$('.batchOption').show();
					var result = '<div class="fileList bbord">';
					result += '<h3>' + r.msg + '</h3>';
					result += '<table><thead><tr>';
					result += '<td>书名</td><td>作者</td><td>格式</td><td>文件路径</td>';
					result += '</tr></thead><tbody>';					
					for(var key in r.legal) {
						var file = r.legal[key];
						result += '<tr>';
						result += '<td>' + file.bname + '</td>';
						result += '<td>' + file.bauthor + '</td>';
						result += '<td>' + file.bformat + '</td>';
						result += '<td>' + file.bpath + '</td>';
						result += '</tr>';
					}
					result += '</tbody></table></div>';
					$('.main_form').append(result);
					return true;
				} else if(r.code == 1) {
					$('.main_form').append('<div class="fileList">' + r.msg + '</div>');
				} else if(r.code == 2) {
					var result = '<div class="fileList bbord">';
					result += '<h3>' + r.msg + '</h3>';
					result += '<table><thead><tr>';
					result += '<td>文件路径</td><td>错误提示</td>';
					result += '</tr></thead><tbody>';					
					for(var key in r.illegal) {
						var file = r.illegal[key];
						result += '<tr>';
						result += '<td>' + file.bpath + '</td>';
						result += '<td>' + file.msg + '</td>';
						result += '</tr>';
					}
					result += '</tbody></table></div>';
					$('.main_form').append(result);
				} else {
					alert('操作失败，请重新执行');
				}
			}
		});
		return false;
	}
}
</script>
</body>
</html>
